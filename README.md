# Проектирование интернет-сервиса

Задание:
Спроектировать высоконагруженную систему (достаточно MVP), доказать реализуемость.

## 1.Тема 
Сервис «Stackoverflow», где можно узнать о событиях в городе и купить билеты в кино и на мероприятие

stackoverflow.com популярная система вопросов и ответов о программировании. Этот сайт занимает 53 место по посещаемости в мире.

## 2. Возможные диапазоны нагрузок подобного проекта

Статистика сервиса «Stackoverflow» за 2019 год насчитывает следующее количество посетителей(a.pr-cy.ru):

месяц порядка 669 720 000  
день 21 610 000  
среднее время 5:55 минуты

## 3. Планируемая нагрузка как 30% доля рынка в России

Так как сервис расчитан на поисковую систему вопросов с ответами (93%), то высокая нагрузка создается только большим количеством запросов на поиск и получение информации.

Средний пользователь сервиса находится по 5:55 минут в день. Из этого можно сделать вывод, пользователь, сделает около 4 ежедневных просмотров страниц на посетителя. 

21 610 000(DAU) * 4 (page view per user) / 86400 (seconds in day) * 2 (peak load) = 2000 RPS в пике

Т.к. сайт несет в основном тектовую информацию, то суммарный объем страницы составляет ~ 371Кб (sitechecker.pro) 

При пиковой нагрузке, трафик составит 
371 Кб * 2000(rps) ~ 750Гбит/c

## 4. Логическая схема базы данных (без выбора СУБД) 
![Diagram](https://user-images.githubusercontent.com/18511365/69386472-cfabd880-0cd3-11ea-81a4-f1bcd0873356.jpg)

## 5. Физическая система хранения (конкретные СУБД, шардинг, расчет нагрузки, обоснование реализуемости на основе результатов нагрузочного тестирования)

СУБД PostgreSQL хранение данных объявлений и пользователей
++ удобно для продакшена
++ возможна репликация, шардирование
++ много документации
++ постоянная эксплуатация продукта

NoSQL Redis (key-value) хранилище для хранения сессий пользователей
++ быстрый доступ (около 20мс)
++ возможность самоочищения значений по Expires

Расчёт нагрузки на базу данных:
Пользователь будет переподключаться к VPN, генерировать 4 запроса в базу, раз в 5:55 минут. Получается, что наши потенциальные 21 610 000 пользователей, используя сервис единовременно в обычном режиме, будут генерировать нагрузку 1000 rps select на получение данных.

## 6.Выбор прочих технологий: языки программирования, фреймфорки, протоколы взаимодействия, веб-сервера и т.д.
Языки программирования:

Для реализации сервиса stackoverflow необходимо использовать языки, которые используют многопоточность. Для быстрого старта многопоточность "из коробки". Такие как Golang. Также он является современным трендом построения портала на микросервисной архитектуре

Для сервисов выгодно использовать Golang - так как он обеспечивает достаточно быструю скорость разработки (из-за маленького порога вхождения), вместе с необходимой скоростью работы.

Для упрощения развертки приложения сервисы разместим в docker - контейнерах.

Для мониторинга состояния сервисов будем использавать Prometheus и Graphana для визуализации. Это позволит нам отслеживать показатели и нагрузку на сервисы, снизить вероятность появления аварийных ситуаций.

Для передачи данных внутри приложения будем использовать протокол сериализации protobuf, который обеспечивает выигрыш в 1,5 раза по времени сериализации/десериализации и по занимаемой пямяти над json.

## 7. Расчет нагрузки и потребного оборудования

2000 RPS / (7 серверов * 4 потока * 4 ядра) = 17,8 RPS на ядро

Необходимая конфигурация:  
* 2 ТБ данных SQL на SSD-дисках
* 32 Гб ОЗУ 
* На каждом сервере установлено два SSD-накопителя по 320 ГБ в RAID 1  
* Соотношение read-write 40:60  
* На серверах БД средняя нагрузка на ЦП составит 10% на Intel Xeon E3-1220 V6 OEM
* 2 сервера для распределения нагрузки (load balancers), 1 активный, установлен Proxy  
* 3 активных узла БД, установлена PostgreSQL  
* 2 сервера с поисковым движком ElasticSearch  
* 1 машина с распределённым кэшем под Redis

Итого: 8 серверов  
[Optimal Environment for PostgreSQL](https://severalnines.com/database-blog/setting-optimal-environment-postgresql)


## 8. Выбор хостинга / облачного провайдера и расположения серверов
Для хорошего покрытия следует использовать двухточечное расположение серверов, чтобы не было такого разрыва по времени как на статистике ниже. Например, один в северных широтах Санкт-Петербург(Мурманск) и один Новосибирск  
[Хостинг](http://beget.com/ru)


![image](https://user-images.githubusercontent.com/18511365/69289475-b7718600-0c0d-11ea-9c8e-685dcc4bf6ba.png)


## 9. Cхема балансировки нагрузки (входящего трафика и внутрипроектного, терминация SSL)
Будем использовать абстракцию: пользователь знает об одном адресе, при этом за ним будет скрываться несколько физических серверов с одним и тем же сертификатом. Позволяет увеличивать мощность конкретного адреса, заменять физические машины без изменения адресов подключения на клиентских устройствах.
Будем использовать L7 балансировку с помощью NGINX.

![image](https://user-images.githubusercontent.com/18511365/69387419-d0923980-0cd6-11ea-9a42-0a62e4f97b78.png)

## 10. Обеспечение отказоустойчивости
Для обеспечения отказоустойчивости необходимо иметь дополнительные копии сервисов(особенно ключевых)

Балансируем нагрузку между разными копиями ключевых сервисов
Мониторинг ключевых сервисов и балансеров - определяем реальную нагрузку на сервисы (grafana+prometeus), по необходимости добавляем новые; Быстро реагируем на нештатные ситуации.